# Worklog 2026-02-06

## Changes
- Handelsregister-Importer auf direkte Advanced-Search-URL umgestellt und Playwright-Selektoren an echte Feldnamen/IDs angepasst (inkl. Bundesländer-Checkboxen, Geloescht/Nur-ZN/Aehnlich).
- Playwright-Submit robuster gemacht (Fallback-Endpoints, Retry bei Sitzungshinweis, HTML-Logs nach Submit).
- CRM Lead-Staging Filter-Template auf `selected_status` umgestellt und View-Kontext ergänzt, um `request.GET.status`-Fehler zu vermeiden.

## Notes
- `logs/handelsregister_search.html` und `logs/handelsregister_after_submit.html` werden nach Submit aktualisiert.

## Next
- Handelsregister-Importer erneut ausführen und `logs/handelsregister_after_submit.html` prüfen, ob eine Ergebnis-Tabelle erscheint; Parser ggf. an das echte Result-HTML anpassen.
- Falls weiterhin Session-Hinweis: Submit-Flow prüfen (eventuell JSF-ViewState oder PrimeFaces-POST manuell emulieren).

## Update
- Handelsregister-Importer auf reinen HTTP-POST (requests) umgestellt, damit es auf Linux ohne Browser (Lynx) funktioniert.
- Formularfelder/Hidden Inputs werden aus dem JSF-Formular extrahiert und mit Suchparametern befüllt.
- Cookie-Form wird per POST akzeptiert, Submit mit Retry bei Sitzungshinweis.
- Logs schreiben jetzt auch `logs/handelsregister_after_submit.html` im HTTP-Flow.
- Playwright wartet nur noch auf `attached` (Fallback).

## Update
- Handelsregister HTTP-Importer: Cookie-POST entfernt, Fallback-Submit mit minimalem Payload hinzugefügt.
- Ergebnis-HTML kommt jetzt von `/sucheErgebnisse/welcome.xhtml` und wird geloggt.
- Parser auf Ergebnis-Tabelle umgestellt (BS4, Fallback-Regex), extrahiert nur Firmennamen aus `span.marginLeft20` in `td.paddingBottom20Px`.
- Payload-Logging nach `logs/handelsregister_payload.txt` für Debug.

## Result
- Import läuft durch und erzeugt 100 Treffer (gemäß HTML).

## Note
- Frühere Staging-Einträge enthalten Rauschen (z. B. "Historie", "Zweigniederlassungen") aus dem alten Parser; neue Imports sind sauber.

## Update (Fallback)
- Notfall-Fallback vorbereitet: Provider-Skeletons für `serpapi`, `dataforseo`, `bing` mit zentraler Steuerung über Settings.
- Fallback wird nur genutzt, wenn `CRM_FALLBACK_ENABLED=True` und die Primärquelle 0 Treffer liefert.

## Update (Fallback UI + Integrationen)
- CRM-Fallback-Einstellungen in `SystemSettings` ergänzt (Provider-Reihenfolge + API-Keys).
- Admin-Dashboard erweitert: CRM-Fallback-Konfiguration (Notfall) inkl. Provider-Order und Keys.
- SerpAPI, DataForSEO und Bing Web Search als echte Fallback-Integrationen implementiert.
- Fallback-Steuerung läuft jetzt über `SystemSettings` (nicht über Django Settings).

## Next
- Migration `0013_add_crm_fallback_settings` ausführen.
- API-Keys im Admin-Dashboard hinterlegen und Fallback-Reihenfolge setzen (z. B. `serpapi,dataforseo,bing`).
- Optional: Provider-spezifische Parameter (z. B. Location/Language) in ein eigenes CRM-Settings-Panel überführen.

## Update (Website + E-Mail Enrichment)
- Fallback speichert jetzt `website` aus SerpAPI/DataForSEO/Bing in `LeadStaging.raw_data`.
- Enrichment erweitert: Wenn keine E-Mail vorhanden ist, wird die Website gecrawlt (Startseite + Kontakt/Impressum) und E-Mail extrahiert.
- Admin-Dashboard um optionales Enrichment-API Panel erweitert (Hunter/Dropcontact/Clearbit), aktuell nur Konfiguration.

## Next (Enrichment)
- Migration `0014_add_crm_enrichment_settings` ausführen.
- Optional: Enrichment-APIs anbinden (Hunter/Dropcontact/Clearbit), wenn Keys vorhanden.

## Update (UI Staging)
- Lead-Staging Tabelle zeigt jetzt Website (als Domain) und Adresse.
- E-Mail aus Website wird mit Badge "Web" markiert.
- Lead-Staging Edit-Formular enthält editierbare Felder für Website und Adresse (gespeichert in `raw_data`).

## Update (Lead Import)
- Lead-Modell erweitert um `website` und `address`.
- Lead-Import übernimmt Website/Adresse aus Staging (und schreibt Adresse bei Bedarf in `raw_data`).

## Update (Run)
- Fallback aktiviert (Reihenfolge: serpapi,dataforseo,bing).
- Staging neu importiert (60 Einträge).
- Auto-Enrich für alle Staging-Einträge ausgeführt.

## Update (Staging Workflow)
- Staging-Liste vereinfacht: Details jetzt im Modal, neue Aktion "Website gesucht".
- Quick-Update Modal für Website/Adresse (speichert in `raw_data`).
- Auto-Enrich verarbeitet nur Einträge mit Website; ohne Website werden auf `needs_website` gesetzt.

## Update (Needs Website View)
- Neue Seite `/crm/staging/needs-website/` mit Batch-Editor für Websites/Adressen.
- Neue Route `/crm/staging/batch-website/` für Sammelspeichern.

## Update (Filters + Enrich)
- Filter "Nur ohne Website" in Staging-Liste.
- Auto-enrich Button in der Needs-Website-Ansicht.

## Ideen (Nächste Apps)
- Vertragsverwaltung (KI: Klausel-Erkennung, Risiken, Zusammenfassung).
- Marketing-Tools/Automation (KI: Texte, Segmente, Kampagnen).
- Angebots-/Proposal-Tool (KI: Angebotsvorschläge aus CRM).
- Dokumenten-Hub (Suche/Summary).
- Word/Excel-ähnliche Tools (Docs/Sheets light).

## Update (Contracts MVP)
- Neue App `contracts` mit CRUD: Liste, Detail, Erstellen, Bearbeiten, Versionen.
- Modelle: `Contract`, `ContractVersion` (Datei-Uploads, Status, Termine, Wert).
- URLs unter `/contracts/`.
 - App-Toggle für Contracts ergänzt (Admin-Dashboard + Middleware).

## Update (Contracts AI)
- KI-Analyse für Verträge: Summary, Risiken, Checkliste, Key Dates.
- Analyse aus PDF/DOCX + Notizen (Bedrock).
- Button "KI Analyse" in Vertragsdetails.
- PyPDF2 hinzugefügt.

## Update (Bedrock Config)
- Bedrock-Einstellungen sind im /admin-dashboard/ verfügbar (Enable, API-Key, Region, Model-ID, Max Tokens, Temperatur).
- Vertrag-KI scheiterte bisher wegen fehlender Credentials; sobald der Key im Admin-Dashboard gespeichert ist, läuft die Analyse.

## Next
- Bedrock-API-Key + Modell im Admin-Dashboard setzen und ‘KI Analyse’ erneut ausführen.


## Update (CRM AI)
- Lead erweitert um KI-Felder (Summary, Next Steps, Follow-up Entwurf, Q&A, Status).
- Lead-Detailseite: KI-Zusammenfassung + nächste Schritte, Follow-up-Entwurf, Q&A.
- Lead-Scoring: AI liefert jetzt Score + Begründung (JSON), fallback auf Zahl.
- Bedrock-Check über SystemSettings (Admin-Dashboard).


## Test (CRM AI)
- Migration angewendet. Test-Lead 'Test Lead KI' + Note erstellt.
- Bedrock-Aufruf für Follow-up-Entwurf lief in 429 (Rate Limit). Kurz warten und erneut testen.


## Update (CRM Leads Cleanup + Auto-Enrich)
- Alle Leads ohne Adresse ODER Website gelöscht.
- Auto-Enrich beim Lead-Erstellen/Update: Wenn Website vorhanden, wird versucht Telefon/Adresse/E-Mail von der Website zu extrahieren.


## Update (CRM Lead Enrich Button)
- Button in Lead-Detail: 'Lead aus Website anreichern'.
- Aktion in LeadDetailView verdrahtet.

## Update (CRM Notes + Activities)
- Lead-Detail: Notizen + Aktivitäten mit Formularen hinzugefügt.
- LeadDetailView: Aktionen add_note/add_activity; Listen im Kontext.


## Update (CRM Account Notes + Activities)
- Account-Detail: Notizen + Aktivitäten mit Formularen hinzugefügt.
- AccountDetailView: Aktionen add_note/add_activity; Listen im Kontext.


## Update (CRM Hilfe + API)
- Hilfe-Seite unter /crm/help/ inkl. Quickstart, KI, Auto-Enrich, Rechte.
- Read-Only API: /crm/api/leads/, /crm/api/accounts/, /crm/api/opportunities/ + Detail-Endpunkte.
- CRM-Navigation um Hilfe-Link erweitert.


## Update (CRM API + Help)
- CRM API (Read/Write) mit DRF: Leads, Accounts, Opportunities, Activities, Notes.
- Swagger für CRM: /crm/api/docs/ und Schema /crm/api/schema/.
- CRM Hilfe aktualisiert.

## Update (Contracts API + Help)
- Contracts API (Read/Write) mit DRF: Contracts + Versions.
- Swagger für Contracts: /contracts/api/docs/ und Schema /contracts/api/schema/.
- Vertrags-Hilfe-Seite unter /contracts/help/.


## Update (Contracts Permissions)
- Contracts UI + API jetzt mit Gruppenrechten wie CRM (Orga lesen, Manager schreiben).


## Plan/Struktur (Helpdesk Bereiche)
- Neue Struktur-Modelle: SupportDepartment, SupportQueue, TicketRoutingRule.
- Ziel: Ticket-Benachrichtigungen + Zuweisung später nach Bereich/Queue + Support-Level steuern.
- Nächster Schritt: Ticket-Erstellung/Routing an diese Struktur anbinden (Benachrichtigungen je Gruppe/Bereich).


## Update (Helpdesk Bereiche + Routing + Filter)
- Ticket bekommt department + queue Felder.
- RoutingRules werden bei Ticket-Erstellung angewendet (Kategorie/Keyword, Priorität, Support-Level, Department/Queue).
- Benachrichtigungen für neue Tickets gehen nach Department/Queue-Gruppen (falls gesetzt), sonst Standard L1/L2.
- Ticket-Liste: Filter für Bereich/Queue + 'Meine Bereiche'.


## Update (Marketing App)
- Marketing-App erstellt: Kampagnen, Content-Assets, Ideen, Freigaben + AI-Generator.
- URL /marketing/ integriert + App-Toggle in Admin-Dashboard (global).
- Dashboard-Button fÃ¼r Marketing hinzugefÃ¼gt.
- Systemcheck: manage.py check ok.


## Fix (Marketing Toggle)
- Doppelte Marketing-Keys in App-Toggles entfernt.


## Update (Marketing Workflow)
- ContentAsset: Briefing-Feld + Workflow-Stepper (Briefing -> AI-Entwurf -> Freigabe -> VerÃ¶ffentlichen).
- Asset-Detail: Briefing speichern, AI generieren, Freigabe anfordern, VerÃ¶ffentlichen Aktionen.
- Migration marketing.0002_contentasset_brief angewendet.


## Update (Marketing Erweiterungen)
- Kanal-Templates (LinkedIn/Newsletter/Blog/Ad) + 'Template anwenden' im Asset-Workflow.
- Automatische PrÃ¼fliste vor Freigabe (MindestlÃ¤nge + CTA).
- Kalenderansicht fÃ¼r geplante Inhalte: /marketing/calendar/.
- Asset-Liste zeigt geplantes Datum.


## Update (Marketing Permissions + KPIs + Rules)
- Marketing Permissions: View = Orga/Manager, Edit = Manager, Approve = Orga/Manager.
- Freigabe-Form nur fÃ¼r Approver; Aktionen blockiert ohne Rechte.
- Kampagnen-KPIs (Impressions, Clicks, Conversions, Spend, Revenue) + CTR/CVR/ROI.
- Kanalregeln: LinkedIn Hashtags, Newsletter Betreff, Ad-LÃ¤nge. QA-Checklist erweitert.


## Update (Marketing: KPI Import + Roles + Versioning)
- KPI Import per Kampagne (CSV) inkl. Detailseite: /marketing/campaigns/<id>/.
- Marketing-Rollen im Admin-Dashboard (View/Edit/Approve Gruppen).
- Content Versionierung mit Stempel bei Freigabe/Publish + Anzeige im Asset-Detail.
- Marketing Kalender + Kampagnenliste auf Detail verlinkt.

