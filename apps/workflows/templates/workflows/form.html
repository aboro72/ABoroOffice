{% extends "base.html" %}
{% block title %}Formular{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="card">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <div class="mt-2">
          <label class="form-label">Vorlage anwenden (Trigger)</label>
          <select class="form-select" id="createPreset">
            <option value="">– auswählen –</option>
          </select>
          <div class="text-muted small mt-1">Erstellt JSON‑Filter passend zum Trigger.</div>
        </div>
        <div class="mt-3 border rounded p-2">
          <div class="fw-bold mb-2">Filter Builder</div>
          <div class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Feld</label>
              <select class="form-select" id="builderField">
                <option value="status">Status</option>
                <option value="stage">Stage</option>
                <option value="level">Level</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Operator</label>
              <select class="form-select" id="builderOp">
                <option value="eq">=</option>
                <option value="in">in</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">Wert</label>
              <input class="form-control" id="builderValue" placeholder="z.B. won oder proposal,negotiation">
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-secondary w-100" type="button" id="builderApply">Übernehmen</button>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-outline-secondary" type="button" id="formatJson">JSON formatieren</button>
          <button class="btn btn-outline-secondary" type="button" id="validateJson">JSON prüfen</button>
        </div>
        <button class="btn btn-primary" type="submit">Speichern</button>
      </form>
    </div>
  </div>
</div>
<script>
  (function() {
    const trigger = document.getElementById('triggerType');
    const filters = document.getElementById('triggerFilters');
    const preset = document.getElementById('createPreset');
    const builderField = document.getElementById('builderField');
    const builderOp = document.getElementById('builderOp');
    const builderValue = document.getElementById('builderValue');
    const builderApply = document.getElementById('builderApply');
    const presetsByTrigger = {
      invoice_issued: [
        ['{"status":"issued"}', 'Invoice: Issued'],
        ['{"status":"sent"}', 'Invoice: Sent'],
      ],
      dunning_created: [
        ['{"status":"sent"}', 'Dunning: Sent'],
        ['{"level":2}', 'Dunning: Level 2'],
      ],
      erp_order_status: [
        ['{"status":"confirmed"}', 'Order: Confirmed'],
        ['{"status":"invoiced"}', 'Order: Invoiced'],
      ],
      crm_lead_status: [
        ['{"status":"qualified"}', 'Lead: Qualified'],
        ['{"status":"lost"}', 'Lead: Lost'],
      ],
      crm_opportunity_stage: [
        ['{"stage":"proposal"}', 'Opportunity: Proposal'],
        ['{"stage":["proposal","negotiation"]}', 'Opportunity: Proposal/Negotiation'],
        ['{"stage":"won"}', 'Opportunity: Won'],
      ],
      marketing_asset_status: [
        ['{"status":"approved"}', 'Marketing: Approved'],
        ['{"status":"published"}', 'Marketing: Published'],
      ],
    };
    function loadPresets() {
      if (!preset || !trigger) return;
      preset.innerHTML = '<option value="">– auswählen –</option>';
      const list = presetsByTrigger[trigger.value] || [];
      list.forEach(([val, label]) => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = label;
        preset.appendChild(opt);
      });
    }
    if (preset && filters && trigger) {
      loadPresets();
      trigger.addEventListener('change', loadPresets);
      preset.addEventListener('change', () => {
        if (preset.value) {
          filters.value = preset.value;
        }
      });
    }
    const btnFormat = document.getElementById('formatJson');
    const btnValidate = document.getElementById('validateJson');
    if (btnFormat && filters) {
      btnFormat.addEventListener('click', () => {
        try {
          const obj = JSON.parse(filters.value || '{}');
          filters.value = JSON.stringify(obj, null, 2);
        } catch (e) {
          alert('JSON ungültig: ' + e.message);
        }
      });
    }
    if (btnValidate && filters) {
      btnValidate.addEventListener('click', () => {
        try {
          JSON.parse(filters.value || '{}');
          alert('JSON ist gültig.');
        } catch (e) {
          alert('JSON ungültig: ' + e.message);
        }
      });
    }
    if (builderApply && filters) {
      builderApply.addEventListener('click', () => {
        const field = builderField.value;
        const op = builderOp.value;
        const raw = builderValue.value || '';
        let obj = {};
        try { obj = JSON.parse(filters.value || '{}'); } catch (e) { obj = {}; }
        if (op === 'in') {
          obj[field] = raw.split(',').map(v => v.trim()).filter(Boolean);
        } else {
          obj[field] = raw.trim();
        }
        filters.value = JSON.stringify(obj, null, 2);
      });
    }
  })();
</script>
{% endblock %}
