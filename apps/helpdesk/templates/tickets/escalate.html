{% extends 'base.html' %}
{% load i18n %}

{% block title %}Ticket {% if can_deescalate %}weitergeben{% else %}eskalieren{% endif %} - {{ app_title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        Ticket {{ ticket.ticket_number }} {% if can_deescalate %}weitergeben / eskalieren{% else %}eskalieren{% endif %}
    </div>

    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <strong>Aktueller Status:</strong><br>
        <div style="margin-top: 10px;">
            <strong>Titel:</strong> {{ ticket.title }}<br>
            <strong>Aktueller Support Level:</strong>
            <span class="level-badge level-{{ ticket.support_level }}">
                {% if ticket.support_level == 'level_1' %}Level 1{% endif %}
                {% if ticket.support_level == 'level_2' %}Level 2{% endif %}
                {% if ticket.support_level == 'level_3' %}Level 3{% endif %}
                {% if ticket.support_level == 'level_4' %}Level 4{% endif %}
            </span><br>
            {% if ticket.assigned_to %}
            <strong>Aktuell zugewiesen an:</strong> {{ ticket.assigned_to.full_name }} (Level {{ ticket.assigned_to.support_level }})
            {% endif %}
        </div>
    </div>

    {% if can_deescalate %}
    <div style="background: #d1ecf1; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
        <strong>ℹ️ Hinweis:</strong> Sie können dieses Ticket an niedrigere Support-Levels <strong>zurückgeben</strong> oder weiter nach oben eskalieren.
    </div>
    {% endif %}

    {% if agents %}
    <form method="post">
        {% csrf_token %}

        <div class="form-group">
            <label for="agent_id">An welchen Agent {% if can_deescalate %}weitergeben{% else %}eskalieren{% endif %}?</label>
            <select name="agent_id" id="agent_id" class="form-control" required>
                <option value="">Bitte wählen...</option>
                {% for agent in agents %}
                <option value="{{ agent.id }}"
                        {% if agent.support_level < ticket_level %}style="background-color: #d4edda;"
                        {% elif agent.support_level > ticket_level %}style="background-color: #fff3cd;"
                        {% endif %}>
                    {{ agent.full_name }} - Level {{ agent.support_level }}
                    {% if agent.support_level < ticket_level %}⬇️ (Zurückgeben){% endif %}
                    {% if agent.support_level > ticket_level %}⬆️ (Eskalieren){% endif %}
                    {% if agent.department %} - {{ agent.department }}{% endif %}
                </option>
                {% endfor %}
            </select>
            <small style="color: #868e96;">
                {% if can_deescalate %}
                    Grün = Zurückgeben an niedrigeres Level | Gelb = Eskalieren an höheres Level
                {% else %}
                    Wählen Sie einen Agent mit höherem Support Level.
                {% endif %}
            </small>
        </div>

        <div class="form-group">
            <label for="support_level">{% trans "Neuer Support Level (optional)" %}</label>
            <select name="support_level" id="support_level" class="form-control">
                <option value="">Unverändert lassen</option>
                {% for level_code, level_name in support_levels %}
                    {% if can_deescalate or level_code > ticket.support_level %}
                    <option value="{{ level_code }}">{{ level_name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <small style="color: #868e96;">
                {% if can_deescalate %}
                    Sie können das Ticket zu jedem Level weitergeben.
                {% else %}
                    Sie können nur zu höheren Levels eskalieren.
                {% endif %}
            </small>
        </div>

        <div class="form-group">
            <label for="reason">Grund für die {% if can_deescalate %}Weitergabe{% else %}Eskalation{% endif %}</label>
            <textarea name="reason" id="reason" class="form-control" rows="4" placeholder="Beschreiben Sie den Grund für die Weitergabe..."></textarea>
            <small style="color: #868e96;">Dieser Kommentar ist nur für das Support-Team sichtbar.</small>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button type="submit" class="btn btn-warning">{% trans "Ticket weitergeben" %}</button>
            <a href="{% url 'tickets:detail' ticket.pk %}" class="btn btn-secondary">{% trans "Abbrechen" %}</a>
        </div>
    </form>
    {% else %}
    <div style="background: #e9ecef; padding: 20px; border-radius: 6px; text-align: center;">
        <p style="color: #495057; margin-bottom: 15px;">
            <strong>Keine Agents verfügbar</strong><br>
            Es gibt derzeit keine Agents mit einem höheren Support Level, an die Sie eskalieren könnten.
        </p>
        <a href="{% url 'tickets:detail' ticket.pk %}" class="btn btn-secondary">{% trans "Zurück zum Ticket" %}</a>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3 style="margin-bottom: 15px; font-size: 16px;">{% trans "Support Levels" %}</h3>
    <ul style="line-height: 1.8; color: #495057; padding-left: 20px;">
        <li><strong>Level 1:</strong> First Line Support - Einfache Anfragen und Standardprobleme</li>
        <li><strong>Level 2:</strong> Technical Support - Komplexere technische Probleme</li>
        <li><strong>Level 3:</strong> Expert Support - Sehr komplexe oder kritische Probleme</li>
        <li><strong>Level 4:</strong> Senior Expert - Team Lead, höchste Eskalationsstufe</li>
    </ul>

    <h4 style="margin-top: 20px; margin-bottom: 10px; font-size: 15px;">{% trans "⬆️ Nach oben eskalieren" %}</h4>
    <p style="color: #495057; line-height: 1.6;">{% trans "Eskalieren Sie ein Ticket zu einem höheren Level, wenn:" %}</p>
    <ul style="line-height: 1.8; color: #495057; padding-left: 20px; margin-top: 10px;">
        <li>{% trans "Das Problem außerhalb Ihres Kompetenzbereichs liegt" %}</li>
        <li>{% trans "Spezialwissen erforderlich ist" %}</li>
        <li>{% trans "Das Problem sehr dringend oder kritisch ist" %}</li>
    </ul>

    <h4 style="margin-top: 20px; margin-bottom: 10px; font-size: 15px;">{% trans "⬇️ Zurückgeben an niedrigeres Level" %}</h4>
    <p style="color: #495057; line-height: 1.6;">{% trans "Geben Sie ein Ticket zurück, wenn:" %}</p>
    <ul style="line-height: 1.8; color: #495057; padding-left: 20px; margin-top: 10px;">
        <li>{% trans "Das Problem weniger komplex ist als ursprünglich gedacht" %}</li>
        <li>{% trans "Ein niedrigeres Level das Problem lösen kann" %}</li>
        <li>{% trans "Das Ticket an den falschen Spezialisten gegeben wurde" %}</li>
        <li>{% trans "Weitere Analyse durch First/Second Line Support erforderlich ist" %}</li>
    </ul>
</div>
{% endblock %}
