{% extends 'base.html' %}

{% block title %}{{ ticket.ticket_number }} - {{ app_title }}{% endblock %}

{% block content %}
<!-- Ticket Header -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h1 style="font-size: 24px; font-weight: 600; margin-bottom: 10px;">
                {{ ticket.ticket_number }}: {{ ticket.title }}
            </h1>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <span class="status-badge status-{{ ticket.status }}">
                    {% if ticket.status == 'open' %}Offen{% endif %}
                    {% if ticket.status == 'in_progress' %}In Bearbeitung{% endif %}
                    {% if ticket.status == 'pending' %}Wartet auf Kunde{% endif %}
                    {% if ticket.status == 'resolved' %}Gel√∂st{% endif %}
                    {% if ticket.status == 'closed' %}Geschlossen{% endif %}
                </span>
                <span class="priority-badge priority-{{ ticket.priority }}">
                    {% if ticket.priority == 'low' %}Niedrig{% endif %}
                    {% if ticket.priority == 'medium' %}Mittel{% endif %}
                    {% if ticket.priority == 'high' %}Hoch{% endif %}
                    {% if ticket.priority == 'critical' %}Kritisch{% endif %}
                </span>
                <span class="level-badge level-{{ ticket.support_level }}">
                    {% if ticket.support_level == 'level_1' %}Support Level 1{% endif %}
                    {% if ticket.support_level == 'level_2' %}Support Level 2{% endif %}
                    {% if ticket.support_level == 'level_3' %}Support Level 3{% endif %}
                </span>
            </div>
        </div>

        {% if user.role != 'customer' and ticket.status != 'closed' %}
        <div style="display: flex; gap: 10px;">
            <!-- Self-assign button for agents -->
            {% if not ticket.assigned_to and user.role == 'support_agent' %}
            <form method="post" action="{% url 'tickets:assign' ticket.pk %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-sm">Mir zuweisen</button>
            </form>
            {% endif %}

            <!-- Assign button for team leads (Level 4) -->
            {% if not ticket.assigned_to and user.role == 'support_agent' and user.support_level == 4 %}
            <button type="button" class="btn btn-info btn-sm" onclick="document.getElementById('assignModal').style.display='block';">Agent zuweisen</button>
            {% endif %}

            <!-- Escalate button for agents working on ticket -->
            {% if ticket.assigned_to == user and user.role == 'support_agent' %}
            <a href="{% url 'tickets:escalate' ticket.pk %}" class="btn btn-warning btn-sm">Nach oben eskalieren</a>
            {% endif %}

            <!-- Close button for assigned agent, team lead, or admin -->
            {% if ticket.assigned_to == user or user.role == 'admin' or user.support_level == 4 %}
            <form method="post" action="{% url 'tickets:close' ticket.pk %}" style="margin: 0;" onsubmit="return confirm('Ticket wirklich schlie√üen? Der Verlauf wird an den Kunden gesendet.');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm">Schlie√üen</button>
            </form>
            {% endif %}
        </div>
        {% endif %}

        <!-- Modal for agent assignment (Team Lead only) -->
        {% if user.role == 'support_agent' and user.support_level == 4 %}
        <div id="assignModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; border-radius: 8px;">
                <span style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="document.getElementById('assignModal').style.display='none';">&times;</span>
                <h2 style="margin-top: 0; font-size: 18px;">Agent ausw√§hlen</h2>
                <form method="post" action="{% url 'tickets:assign' ticket.pk %}" style="margin: 0;">
                    {% csrf_token %}
                    <div style="margin-bottom: 15px;">
                        <label for="agent_id" style="display: block; margin-bottom: 5px; font-weight: 600;">Support Agent:</label>
                        <select name="agent_id" id="agent_id" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" required>
                            <option value="">-- Agent ausw√§hlen --</option>
                            {% for agent in team_agents %}
                            <option value="{{ agent.id }}">{{ agent.full_name }} (Level {{ agent.support_level }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Zuweisen</button>
                        <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('assignModal').style.display='none';">Abbrechen</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Ticket Info -->
<div class="card">
    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">Ticket-Informationen</h3>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Erstellt von</p>
            <p style="font-weight: 500;">{{ ticket.created_by.full_name }}</p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Telefonnummer</p>
            <p style="font-weight: 500;">
                {% if ticket.created_by.phone %}
                    <a href="tel:{{ ticket.created_by.phone }}" style="color: #667eea; text-decoration: none;">{{ ticket.created_by.phone }}</a>
                {% else %}
                    <span style="color: #868e96;">Nicht angegeben</span>
                {% endif %}
            </p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Erstellt am</p>
            <p style="font-weight: 500;">{{ ticket.created_at|date:"d.m.Y H:i" }} Uhr</p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Zugewiesen an</p>
            <p style="font-weight: 500;">
                {% if ticket.assigned_to %}
                    {{ ticket.assigned_to.full_name }}
                    {% if ticket.assigned_to.support_level %}
                        <span class="level-badge level-level_{{ ticket.assigned_to.support_level }}">L{{ ticket.assigned_to.support_level }}</span>
                    {% endif %}
                {% else %}
                    <span style="color: #868e96;">Noch nicht zugewiesen</span>
                {% endif %}
            </p>
        </div>
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Kategorie</p>
            <p style="font-weight: 500;">{{ ticket.category.name|default:"Keine" }}</p>
        </div>
        <!-- Mobile classroom field removed -->
        {% if ticket.closed_at %}
        <div>
            <p style="color: #868e96; font-size: 13px; margin-bottom: 5px;">Geschlossen am</p>
            <p style="font-weight: 500;">{{ ticket.closed_at|date:"d.m.Y H:i" }} Uhr</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Ticket Description -->
<div class="card">
    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">Beschreibung</h3>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; line-height: 1.6;">
        {{ ticket.description|linebreaks }}
    </div>
</div>

<!-- Comments / Chat -->
<div class="card">
    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">Kommunikation</h3>

    {% if comments %}
    <div style="margin-bottom: 30px;">
        {% for comment in comments %}
        <div style="margin-bottom: 20px; {% if comment.is_internal %}background: #fff3cd; {% else %}background: #f8f9fa; {% endif %}padding: 15px; border-radius: 8px; border-left: 4px solid {% if comment.author.role == 'customer' %}#667eea{% else %}#51cf66{% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <strong style="color: #495057;">{{ comment.author.full_name }}</strong>
                    <span class="role-badge {{ comment.author.role }}" style="margin-left: 8px; font-size: 11px;">
                        {% if comment.author.role == 'admin' %}Admin{% endif %}
                        {% if comment.author.role == 'support_agent' %}Support{% endif %}
                        {% if comment.author.role == 'customer' %}Kunde{% endif %}
                    </span>
                    {% if comment.is_internal %}
                    <span style="background: #ffc107; color: #333; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; font-weight: 600;">Intern</span>
                    {% endif %}
                </div>
                <span style="color: #868e96; font-size: 13px;">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
            </div>
            <div style="color: #495057; line-height: 1.6;">
                {{ comment.content|linebreaks }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="color: #868e96; text-align: center; padding: 30px 0;">Noch keine Kommentare vorhanden.</p>
    {% endif %}

    <!-- Add Comment Form -->
    {% if ticket.status != 'closed' %}
    <div style="border-top: 2px solid #f0f0f0; padding-top: 20px;">
        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 15px;">Neue Nachricht hinzuf√ºgen</h4>

        {% if user.role != 'customer' %}
        <!-- AI Suggestion Button for Agents -->
        <div style="margin-bottom: 15px;">
            <button type="button" id="aiSuggestBtn" class="btn btn-info btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 8px 16px;">
                ü§ñ AI-Antwortvorschlag generieren
            </button>
            <span id="aiLoadingMsg" style="display: none; margin-left: 10px; color: #667eea; font-size: 13px;">
                <i class="fa fa-spinner fa-spin"></i> KI generiert Vorschlag...
            </span>
            <div id="aiSuggestionBox" style="display: none; margin-top: 15px; padding: 15px; background: #f0f4ff; border-left: 4px solid #667eea; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: #667eea;">ü§ñ AI-Vorschlag (<span id="aiProvider"></span>)</strong>
                    <div>
                        <button type="button" id="aiUseBtn" class="btn btn-success btn-sm" style="padding: 4px 12px; font-size: 12px;">Verwenden</button>
                        <button type="button" id="aiDismissBtn" class="btn btn-secondary btn-sm" style="padding: 4px 12px; font-size: 12px;">Verwerfen</button>
                    </div>
                </div>
                <div id="aiSuggestionText" style="color: #495057; line-height: 1.6; white-space: pre-wrap; font-family: inherit;"></div>
                <div id="aiKbArticles" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; display: none;">
                    <small style="color: #868e96;"><strong>Verwendete Wissensdatenbank-Artikel:</strong></small>
                    <ul id="aiKbList" style="margin: 5px 0 0 20px; font-size: 12px; color: #868e96;"></ul>
                </div>
            </div>
        </div>
        {% endif %}

        <form method="post" id="commentForm">
            {% csrf_token %}

            <div class="form-group">
                {{ form.content }}
            </div>

            {% if user.role != 'customer' %}
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                {{ form.is_internal }}
                <label for="{{ form.is_internal.id_for_label }}" style="margin: 0; cursor: pointer;">
                    {{ form.is_internal.label }}
                </label>
            </div>
            {% endif %}

            <button type="submit" class="btn btn-primary">Nachricht senden</button>
        </form>
    </div>
    {% else %}
    <div style="background: #e9ecef; padding: 15px; border-radius: 6px; text-align: center; color: #495057;">
        Dieses Ticket ist geschlossen. Sie k√∂nnen keine weiteren Kommentare hinzuf√ºgen.
    </div>
    {% endif %}
</div>

<!-- Back Button -->
<div style="margin-top: 20px;">
    <a href="{% url 'tickets:list' %}" class="btn btn-secondary">‚Üê Zur√ºck zur √úbersicht</a>
</div>

{% if user.role != 'customer' %}
<!-- AI Suggestion JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const aiSuggestBtn = document.getElementById('aiSuggestBtn');
    const aiLoadingMsg = document.getElementById('aiLoadingMsg');
    const aiSuggestionBox = document.getElementById('aiSuggestionBox');
    const aiSuggestionText = document.getElementById('aiSuggestionText');
    const aiProvider = document.getElementById('aiProvider');
    const aiUseBtn = document.getElementById('aiUseBtn');
    const aiDismissBtn = document.getElementById('aiDismissBtn');
    const aiKbArticles = document.getElementById('aiKbArticles');
    const aiKbList = document.getElementById('aiKbList');
    const contentField = document.querySelector('textarea[name="content"]');

    if (!aiSuggestBtn) return;

    // Get ticket ID from URL
    const ticketId = {{ ticket.pk }};

    aiSuggestBtn.addEventListener('click', function() {
        // Show loading state
        aiSuggestBtn.disabled = true;
        aiLoadingMsg.style.display = 'inline';
        aiSuggestionBox.style.display = 'none';

        // Make AJAX request
        fetch(`/tickets/${ticketId}/api/ai-suggest/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            aiLoadingMsg.style.display = 'none';
            aiSuggestBtn.disabled = false;

            if (data.success) {
                // Show suggestion
                aiSuggestionText.textContent = data.text;
                aiProvider.textContent = data.provider.toUpperCase();
                aiSuggestionBox.style.display = 'block';

                // Show KB articles if available
                if (data.kb_articles && data.kb_articles.length > 0) {
                    aiKbList.innerHTML = '';
                    data.kb_articles.forEach(article => {
                        const li = document.createElement('li');
                        li.textContent = article.title;
                        aiKbList.appendChild(li);
                    });
                    aiKbArticles.style.display = 'block';
                } else {
                    aiKbArticles.style.display = 'none';
                }
            } else {
                alert('Fehler beim Generieren des Vorschlags: ' + (data.error || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            aiLoadingMsg.style.display = 'none';
            aiSuggestBtn.disabled = false;
            console.error('Error:', error);
            alert('Netzwerkfehler beim Generieren des Vorschlags. Bitte versuchen Sie es erneut.');
        });
    });

    // Use AI suggestion
    aiUseBtn.addEventListener('click', function() {
        contentField.value = aiSuggestionText.textContent;
        aiSuggestionBox.style.display = 'none';
        contentField.focus();

        // Scroll to content field
        contentField.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    // Dismiss AI suggestion
    aiDismissBtn.addEventListener('click', function() {
        aiSuggestionBox.style.display = 'none';
    });
});
</script>
{% endif %}

{% endblock %}
