{% extends "base.html" %}

{% block title %}Sales Order {{ order.order_number|default:order.id }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Sales Order {{ order.order_number|default:order.id }}</h2>
            <div class="text-muted">
                Kunde: {% if order.customer %}{{ order.customer.name }}{% else %}-{% endif %} · Status: {{ order.get_status_display }}
            </div>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/erp/salesorders/">Zur Liste</a>
            <a class="btn btn-outline-primary" href="/erp/salesorders/{{ order.id }}/edit/">Bearbeiten</a>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">Positionen</div>
                <div class="card-body">
                    <div class="table-responsive mb-3">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Produkt</th>
                                    <th>Menge</th>
                                    <th>Preis</th>
                                    <th>Summe</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in items %}
                                <tr>
                                    <td>{% if i.product %}{{ i.product.name }}{% else %}-{% endif %}</td>
                                    <td>{{ i.quantity }}</td>
                                    <td>{{ i.unit_price }}</td>
                                    <td>{{ i.line_total }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" class="text-center text-muted py-3">Keine Positionen.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <form method="post" class="row g-2">
                        {% csrf_token %}
                        <div class="col-md-5">
                            {{ item_form.product }}
                        </div>
                        <div class="col-md-2">
                            {{ item_form.quantity }}
                        </div>
                        <div class="col-md-3">
                            {{ item_form.unit_price }}
                        </div>
                        <div class="col-md-2 d-grid">
                            <button class="btn btn-primary" name="add_item" type="submit">Hinzufuegen</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">Summen</div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span>Netto</span>
                        <strong>{{ order.net_amount }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>MwSt ({{ order.tax_rate }}%)</span>
                        <strong>{{ order.tax_amount }}</strong>
                    </div>
                    <div class="d-flex justify-content-between border-top pt-2 mt-2">
                        <span>Brutto</span>
                        <strong>{{ order.total_amount }}</strong>
                    </div>
                    <form method="post" class="mt-3">
                        {% csrf_token %}
                        <button class="btn btn-success w-100" name="create_invoice" type="submit">
                            Rechnung erstellen
                        </button>
                    </form>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">Rechnungen</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for inv in invoices %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/erp/invoices/{{ inv.id }}/">{{ inv.number }}</a>
                            <span class="badge bg-secondary">{{ inv.get_status_display }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-muted">Keine Rechnungen.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">Auftragsbestätigungen</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for conf in confirmations %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ conf.number }}</span>
                            <span class="badge bg-secondary">{{ conf.get_status_display }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-muted">Keine Bestätigungen.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
